<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Huge Smackdown</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      color: white;
      font-family: Arial, sans-serif;
    }
    video {
      max-width: 80%;
      max-height: 80%;
    }
    #scoreBoard {
      position: absolute;
      top: 10px;
      text-align: center;
      font-size: 24px;
      width: 100%;
    }
  </style>
</head>
<body>
  <h1 id="gameTitle" style="position:absolute;top:0;margin:10px;font-size:32px;width:100%;text-align:left; left: 10px;">Huge Smackdown</h1>
  <div id="scoreBoard">Score: 0<br>Location: Loading...</div>
  <video id="trumpVideo" preload="auto" muted autoplay></video>
  <audio id="clickSound" src="click.mp3" preload="auto"></audio>

  <script>
    const video = document.getElementById('trumpVideo');
    const clickSound = document.getElementById('clickSound');
    const scoreBoard = document.getElementById('scoreBoard');

    video.src = 'trumpcomplete.mp4';

    let interactionTimer = null;
    let looping = true;
    let lastInteraction = Date.now();
    let score = 0;
    let country = 'Loading...';
    let countryCode = '';
    window.scoreChanged = false;

    video.muted = true;

    fetch('https://ipapi.co/json/')
      .then(response => response.json())
      .then(data => {
        country = data.country_name || 'Unknown';
        countryCode = data.country_code ? data.country_code.toLowerCase() : '';
        updateScoreBoard();
        startScoreReporter();
      })
      .catch(() => {
        country = 'Unknown';
        updateScoreBoard();
        startScoreReporter();
      });

    function updateScoreBoard() {
      let flagHTML = countryCode ? `<img class="flag" src="https://flagcdn.com/${countryCode}.svg" alt="flag" 
style="width:24px;height:16px;vertical-align:middle;margin-left:5px;">` : '';
      scoreBoard.innerHTML = `Score: ${score}<br>Location: ${country}${flagHTML}`;
    }

    video.addEventListener('loadedmetadata', () => {
      video.currentTime = 0;
      video.play();
    });

    video.addEventListener('timeupdate', () => {
      if (looping && video.currentTime >= 0.1) {
        video.currentTime = 0;
      }

      if (!looping && videoState === 'clickPlay' && video.currentTime >= 2.1) {
        loopStart();
      }

      if (videoState === 'idlePlay' && video.currentTime >= video.duration) {
        console.log("Game Over");
      }
    });

    let videoState = 'looping';

    function loopStart() {
      looping = true;
      videoState = 'looping';
      video.muted = true;
      video.currentTime = 0;
      video.play();
    }

    function playClickSegment() {
      looping = false;
      videoState = 'clickPlay';
      video.muted = false;
      video.currentTime = 0.1;
      video.play();
      clickSound.play();
    }

    function playIdleSegment() {
      looping = false;
      videoState = 'idlePlay';
      video.muted = false;
      video.currentTime = 2.2;
      video.play();
    }

    function resetInactivityTimer() {
      lastInteraction = Date.now();
      clearTimeout(interactionTimer);
      interactionTimer = setTimeout(() => {
        if (Date.now() - lastInteraction >= 10000 && videoState === 'looping') {
          playIdleSegment();
        }
      }, 10000);
    }

    document.body.addEventListener('click', () => {
      resetInactivityTimer();
      if (videoState === 'looping') {
        playClickSegment();
        score += 1;
        window.scoreChanged = true;
        updateScoreBoard();
      }
    });

    resetInactivityTimer();

    function startScoreReporter() {
      setInterval(() => {
        if (country !== 'Loading...' && window.scoreChanged) {
          window.scoreChanged = false;
          fetch('https://hugesmackdown-api.onrender.com/score', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ country })
          }).catch((e) => console.error("Score submit failed", e));
        }
      }, 500);
    }
  </script>
</body>
</html>

